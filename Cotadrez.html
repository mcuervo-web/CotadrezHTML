<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotadrez - El Juicio del Rey</title>
    <style>
        body { background-color: #1a252f; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .game-layout { display: flex; gap: 30px; align-items: flex-start; margin-top: 20px; }
        .inventory-panel { width: 175px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; border: 2px solid #34495e; min-height: 550px; }
        .list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #board { display: grid; grid-template-columns: repeat(10, 55px); grid-template-rows: repeat(10, 55px); border: 8px solid #34495e; background: #2c3e50; }
        .tile { width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; position: relative; box-sizing: border-box; }
        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .water { background-color: #3498db !important; }
        .deploy-zone { box-shadow: inset 0 0 0 4px #f1c40f; z-index: 2; }
        .valid-drop { background-color: rgba(46, 204, 113, 0.6) !important; }
        .invalid-ghost { background-color: rgba(231, 76, 60, 0.7) !important; }
        .inventory-item { width: 55px; height: 55px; background: rgba(0,0,0,0.2); border-radius: 8px; position: relative; cursor: grab; display: flex; justify-content: center; align-items: center; }
        .inventory-item img { width: 85%; height: 85%; pointer-events: none; }
        .inventory-item.locked { opacity: 0.15; filter: grayscale(1); pointer-events: none; }
        .badge { position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 1px solid white; pointer-events: none; }
        .piece-on-board { width: 90%; height: 90%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); cursor: grab; transition: opacity 0.3s; }
        #status-msg { margin-bottom: 15px; font-size: 1.2em; color: #f1c40f; height: 50px; text-align: center; font-weight: bold; max-width: 700px; line-height: 1.2; }
        .dungeon { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; min-height: 60px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; padding: 5px; position: relative; }
        .dungeon::before { content: "MAZMORRA"; position: absolute; top: -10px; left: 10px; font-size: 10px; background: #1a252f; padding: 0 5px; color: #777; }
        .dungeon img { width: 24px; height: 24px; filter: sepia(0.4); }
    </style>
</head>
<body>

    <h1>COTADREZ</h1>
    <div id="status-msg">Iniciando Cotadrez...</div>

    <div class="game-layout">
        <div class="inventory-panel" id="inv-rojo">
            <h3 style="color:#e74c3c; text-align:center;">ROJO</h3>
            <div id="list-rojo" class="list"></div>
            <div class="dungeon" id="dungeon-rojo"></div>
        </div>
        <div id="board"></div>
        <div class="inventory-panel" id="inv-negro">
            <h3 style="color:#bdc3c7; text-align:center;">NEGRO</h3>
            <div id="list-negro" class="list"></div>
            <div class="dungeon" id="dungeon-negro"></div>
        </div>
    </div>

<script>
const CONFIG = {
    user: "mcuervo-web", repo: "Cotadrez", branch: "main",
    piezas: [
        { id: "fortaleza", archivo: "Castillo.svg", cant: 1, size: 2, ignoraAgua: true },
        { id: "montana", archivo: "Montana.svg", cant: 3, size: 1 },
        { id: "chusma", archivo: "Chusma.svg", cant: 3, size: 1 },
        { id: "lanceros", archivo: "Lanza.svg", cant: 3, size: 1 },
        { id: "arqueros", archivo: "Arco.svg", cant: 3, size: 1 },
        { id: "c_ligera", archivo: "CaballeriaL.svg", cant: 3, size: 1 },
        { id: "c_pesada", archivo: "CaballeriaP.svg", cant: 2, size: 1 },
        { id: "elefante", archivo: "Elefante.svg", cant: 2, size: 1 },
        { id: "dragon", archivo: "Dragon.svg", cant: 1, size: 1, vuela: true },
        { id: "rey", archivo: "Rey.svg", cant: 1, size: 1 }
    ]
};

const waterCoords = ["1,3", "3,1", "1,6", "3,8", "6,1", "8,3", "6,8", "8,6"];
let stock = { rojo: {}, negro: {} }, mazmorra = { rojo: [], negro: [] };
let fortalezaColocada = { rojo: false, negro: false }, zonasDespliegue = { rojo: [], negro: [] };
let mitadesAsignadas = { rojo: null, negro: null }, bandoQueEmpezo = null;
let turnoActual = null, faseJuego = "despliegue", gameOver = false;
let draggingPieceId = null, draggingArmy = null, draggingOriginTile = null;
let chusmasMovidasEsteTurno = 0, ultimaChusmaGid = null;

function init() {
    CONFIG.piezas.forEach(p => { stock.rojo[p.id] = p.cant; stock.negro[p.id] = p.cant; });
    createBoard();
    updateInventories();
    document.getElementById('status-msg').innerText = "El primer jugador elige color y mitad";
}

function getUrl(bando, archivo) {
    return `https://cdn.jsdelivr.net/gh/${CONFIG.user}/${CONFIG.repo}@${CONFIG.branch}/${bando==='rojo'?'Rojo':'Negro'}/${archivo}`;
}

function createBoard() {
    const b = document.getElementById('board');
    b.innerHTML = '';
    for(let r=0; r<10; r++){
        for(let c=0; c<10; c++){
            const t = document.createElement('div');
            t.className = `tile ${(r+c)%2===0?'light':'dark'}`;
            if(waterCoords.includes(`${r},${c}`)) t.classList.add('water');
            t.dataset.row = r; t.dataset.col = c;
            t.addEventListener('dragover', handleDragOver);
            t.addEventListener('drop', handleDrop);
            t.addEventListener('contextmenu', handleRemove);
            t.addEventListener('click', handleFortressClick);
            b.appendChild(t);
        }
    }
}

function updateInventories() {
    ['rojo', 'negro'].forEach(army => {
        const panel = document.getElementById(`inv-${army}`);
        const list = document.getElementById(`list-${army}`);
        const dung = document.getElementById(`dungeon-${army}`);
        panel.style.visibility = (turnoActual && turnoActual !== army) ? "hidden" : "visible";
        list.innerHTML = '';
        CONFIG.piezas.forEach(p => {
            const n = stock[army][p.id];
            if (n <= 0) return;
            const item = document.createElement('div');
            item.className = `inventory-item ${(!fortalezaColocada[army] && p.id !== "fortaleza")?'locked':''}`;
            item.draggable = !item.classList.contains('locked');
            item.innerHTML = `<img src="${getUrl(army, p.archivo)}">${n>1?`<span class="badge">${n}</span>`:''}`;
            item.ondragstart = () => { draggingPieceId = p.id; draggingArmy = army; draggingOriginTile = null; };
            list.appendChild(item);
        });
        dung.innerHTML = '';
        mazmorra[army].forEach(pid => {
            const enem = (army === 'rojo') ? 'negro' : 'rojo';
            const pData = CONFIG.piezas.find(x => x.id === pid);
            dung.innerHTML += `<img src="${getUrl(enem, pData.archivo)}" title="${pid}">`;
        });
    });
}

function getPieceAt(r, c) {
    const t = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
    return t ? t.querySelector('.piece-on-board') : null;
}

// --- MOTOR DE AMENAZAS Y JAQUE ---

function getThreats(targetR, targetC, attackerArmy, ignoreImg = null) {
    let threats = [];
    document.querySelectorAll('.piece-on-board').forEach(img => {
        if (img.dataset.army === attackerArmy && img !== ignoreImg && img.style.opacity !== "0") {
            const tr = parseInt(img.parentElement.dataset.row), tc = parseInt(img.parentElement.dataset.col);
            const dr = Math.abs(targetR - tr), dc = Math.abs(targetC - tc);
            const pid = img.dataset.pieceId;
            let reaches = false;

            if (pid === "chusma" || pid === "lanceros") reaches = (dr + dc === 1);
            else if (pid === "rey") reaches = (dr <= 1 && dc <= 1);
            else if (pid === "arqueros") reaches = (dr === dc && dr >= 1 && dr <= 2);
            else if (pid === "c_pesada") reaches = (dr === 2 && dc === 1) || (dr === 1 && dc === 2);
            else if (pid === "c_ligera") reaches = (dr === 3 && dc === 1) || (dr === 1 && dc === 3);
            else if (pid === "elefante") {
                if (dr === 0 || dc === 0) {
                    reaches = true;
                    const sR = dr === 0 ? 0 : (targetR > tr ? 1 : -1), sC = dc === 0 ? 0 : (targetC > tc ? 1 : -1);
                    let cr = tr + sR, cc = tc + sC;
                    while (cr !== targetR || cc !== targetC) { if (getPieceAt(cr, cc)) { reaches = false; break; } cr += sR; cc += sC; }
                }
            } else if (pid === "dragon") {
                if (dr === 0 || dc === 0 || dr === dc) {
                    reaches = true;
                    const sR = dr === 0 ? 0 : (targetR > tr ? 1 : -1), sC = dc === 0 ? 0 : (targetC > tc ? 1 : -1);
                    let cr = tr + sR, cc = tc + sC;
                    while (cr !== targetR || cc !== targetC) { if (getPieceAt(cr, cc)) { reaches = false; break; } cr += sR; cc += sC; }
                }
            }
            if (reaches) threats.push(img);
        }
    });
    return threats;
}

function isKingInCheck(army) {
    const king = document.querySelector(`.piece-on-board[data-army="${army}"][data-piece-id="rey"]`);
    if (!king) return false;
    const r = parseInt(king.parentElement.dataset.row), c = parseInt(king.parentElement.dataset.col);
    return getThreats(r, c, army === 'rojo' ? 'negro' : 'rojo').length > 0;
}

// --- GESTIÓN DE MOVIMIENTO ---

function handleDragOver(e) {
    e.preventDefault();
    if (!draggingPieceId || gameOver) return;
    const r = parseInt(this.dataset.row), c = parseInt(this.dataset.col);
    const p = CONFIG.piezas.find(x => x.id === draggingPieceId);
    document.querySelectorAll('.tile').forEach(t => t.classList.remove('valid-drop', 'invalid-ghost'));
    
    let esValido = false;
    const targetImg = getPieceAt(r, c);

    if (faseJuego === "despliegue") {
        esValido = true;
        let minR = !bandoQueEmpezo ? (r < 5 ? 0 : 5) : (mitadesAsignadas[draggingArmy] === 'norte' ? 0 : 5);
        let maxR = !bandoQueEmpezo ? (r < 5 ? 4 : 9) : (mitadesAsignadas[draggingArmy] === 'norte' ? 4 : 9);
        for (let i = 0; i < p.size; i++) for (let j = 0; j < p.size; j++) {
            const tr = r+i, tc = c+j, t = document.querySelector(`[data-row="${tr}"][data-col="${tc}"]`);
            if (!t || t.children.length > 0 || (!p.ignoraAgua && waterCoords.includes(`${tr},${tc}`))) esValido = false;
            if (p.id === "fortaleza" && (tr <= minR || tr >= maxR || tc <= 0 || tc >= 9)) esValido = false;
            else if (p.id === "montana" && (tr < minR || tr > maxR)) esValido = false;
            else if (p.id !== "fortaleza" && p.id !== "montana" && !zonasDespliegue[draggingArmy]?.includes(`${tr},${tc}`)) esValido = false;
        }
    } else {
        if (!draggingOriginTile) return;
        const or = parseInt(draggingOriginTile.dataset.row), oc = parseInt(draggingOriginTile.dataset.col);
        const dr = Math.abs(r - or), dc = Math.abs(c - oc);
        const draggingImg = draggingOriginTile.querySelector('img');

        if (r === or && c === oc) { esValido = true; } 
        else {
            let landOk = true;
            if (this.classList.contains('water') || (targetImg && targetImg.dataset.pieceId === 'montana')) landOk = false;
            if (targetImg) {
                if (targetImg.dataset.pieceId === 'fortaleza') landOk = false;
                if (targetImg.dataset.army === draggingArmy && draggingPieceId !== "lanceros") landOk = false;
                if (targetImg.dataset.pieceId === 'elefante' && targetImg.dataset.army !== draggingArmy) {
                    if (draggingPieceId !== "dragon" && getThreats(r, c, draggingArmy, draggingImg).length < 1) landOk = false;
                }
            }
            // Bloqueo de Rey: No ir a casillas amenazadas
            if (draggingPieceId === "rey" && getThreats(r, c, draggingArmy==='rojo'?'negro':'rojo').length > 0) landOk = false;

            if (landOk) {
                if (draggingPieceId === "dragon") {
                    if (dr === 0 || dc === 0 || dr === dc) {
                        esValido = true;
                        const sR = dr === 0 ? 0 : (r > or ? 1 : -1), sC = dc === 0 ? 0 : (c > oc ? 1 : -1);
                        let tr = or+sR, tc = oc+sC;
                        while (tr !== r || tc !== c) { if (getPieceAt(tr, tc)) { esValido = false; break; } tr += sR; tc += sC; }
                    }
                } else if (draggingPieceId === "elefante") {
                    if (dr === 0 || dc === 0) {
                        esValido = true;
                        const sR = dr === 0 ? 0 : (r > or ? 1 : -1), sC = dc === 0 ? 0 : (c > oc ? 1 : -1);
                        let tr = or+sR, tc = oc+sC;
                        while (tr !== r || tc !== c) { if (getPieceAt(tr, tc) || waterCoords.includes(`${tr},${tc}`)) { esValido = false; break; } tr += sR; tc += sC; }
                    }
                } else if (draggingPieceId === "arqueros") {
                    if (dr === dc && dr >= 1 && dr <= 2) {
                        esValido = true;
                        if (dr === 2) {
                            const mR = (r+or)/2, mC = (c+oc)/2;
                            if (getPieceAt(mR, mC) || waterCoords.includes(`${mR},${mC}`)) esValido = false;
                        }
                    }
                } else if (draggingPieceId === "rey") { esValido = (dr <= 1 && dc <= 1); }
                else if (draggingPieceId === "c_pesada" || draggingPieceId === "c_ligera") {
                    const shape = draggingPieceId === "c_pesada" ? [2, 1] : [3, 1];
                    if ((dr === shape[0] && dc === shape[1]) || (dr === shape[1] && dc === shape[0])) esValido = true;
                } else if (dr + dc === 1) {
                    if (chusmasMovidasEsteTurno === 0 || draggingPieceId === "chusma") {
                        if (!(draggingPieceId === "chusma" && chusmasMovidasEsteTurno === 1 && draggingImg.dataset.groupId === ultimaChusmaGid)) esValido = true;
                    }
                }
            }
        }
    }

    for (let i = 0; i < p.size; i++) for (let j = 0; j < p.size; j++) {
        const t = document.querySelector(`[data-row="${r+i}"][data-col="${c+j}"]`);
        if (t) t.classList.add(esValido ? 'valid-drop' : 'invalid-ghost');
    }
}

function handleDrop(e) {
    e.preventDefault();
    if (!this.classList.contains('valid-drop')) return;
    const r = parseInt(this.dataset.row), c = parseInt(this.dataset.col);

    if (faseJuego === "despliegue") {
        const p = CONFIG.piezas.find(x => x.id === draggingPieceId);
        const gId = `g-${Date.now()}`;
        if (!bandoQueEmpezo && draggingPieceId === "fortaleza") {
            bandoQueEmpezo = draggingArmy; turnoActual = draggingArmy;
            mitadesAsignadas[draggingArmy] = (r < 5) ? 'norte' : 'sur';
            mitadesAsignadas[draggingArmy==='rojo'?'negro':'rojo'] = (r < 5) ? 'sur' : 'norte';
        }
        for (let i = 0; i < p.size; i++) for (let j = 0; j < p.size; j++) {
            document.querySelector(`[data-row="${r+i}"][data-col="${c+j}"]`).appendChild(createPieceImg(draggingArmy, draggingPieceId, gId));
        }
        if (draggingPieceId === "fortaleza") { fortalezaColocada[draggingArmy] = true; actualizarZonas(r, c, draggingArmy); }
        stock[draggingArmy][draggingPieceId]--;
        updateInventories();
    } else {
        const or = parseInt(draggingOriginTile.dataset.row), oc = parseInt(draggingOriginTile.dataset.col);
        if (r === or && c === oc) { if (chusmasMovidasEsteTurno > 0) finalizarTurnoCombate(); return; }

        const targetImg = getPieceAt(r, c);
        const myImg = draggingOriginTile.querySelector('img');
        let captura = false;

        if (targetImg) {
            mazmorra[draggingArmy].push(targetImg.dataset.pieceId);
            document.querySelectorAll(`[data-group-id="${targetImg.dataset.groupId}"]`).forEach(el => el.remove());
            captura = true;
        }
        this.appendChild(myImg);
        
        if (captura || draggingPieceId !== "chusma") finalizarTurnoCombate();
        else {
            chusmasMovidasEsteTurno++; ultimaChusmaGid = myImg.dataset.groupId;
            const chT = document.querySelectorAll(`.piece-on-board[data-army="${turnoActual}"][data-piece-id="chusma"]`).length;
            if (chusmasMovidasEsteTurno >= 2 || chT < 2) finalizarTurnoCombate();
            else document.getElementById('status-msg').innerText = "1/2 Turno: Mueve otra Chusma o suelta aquí para pasar.";
        }
    }
    document.querySelectorAll('.tile').forEach(t => t.classList.remove('valid-drop', 'invalid-ghost'));
}

function handleFortressClick(e) {
    if (faseJuego !== "despliegue") return;
    const img = e.currentTarget.querySelector('.piece-on-board');
    if (!img || img.dataset.pieceId !== 'fortaleza' || img.dataset.army !== turnoActual) return;
    const army = img.dataset.army;
    if (stock[army].montana > 0 || (zonasDespliegue[army] && zonasDespliegue[army].some(coord => {
        const [tr, tc] = coord.split(','), t = document.querySelector(`[data-row="${tr}"][data-col="${tc}"]`);
        return t.children.length === 0 && !t.classList.contains('water');
    }))) return alert("Completa el despliegue.");

    document.querySelectorAll('.tile').forEach(t => t.classList.remove('deploy-zone'));
    if (army === bandoQueEmpezo) {
        document.querySelectorAll(`.piece-on-board[data-army="${army}"]`).forEach(i => i.style.opacity = "0");
        turnoActual = (army === 'rojo') ? 'negro' : 'rojo';
    } else {
        faseJuego = "combate"; turnoActual = bandoQueEmpezo;
        document.querySelectorAll('.piece-on-board').forEach(i => i.style.opacity = "1");
        document.getElementById('status-msg').innerText = `¡Guerra iniciada! Turno del ${turnoActual.toUpperCase()}`;
    }
    updateInventories();
}

function createPieceImg(army, pid, gid) {
    const img = document.createElement('img');
    img.src = getUrl(army, CONFIG.piezas.find(x=>x.id===pid).archivo);
    img.className = "piece-on-board";
    img.dataset.army = army; img.dataset.pieceId = pid; img.dataset.groupId = gid;
    img.draggable = true;
    img.ondragstart = (e) => {
        if (gameOver) { e.preventDefault(); return; }
        if (faseJuego === "combate") {
            if (img.dataset.army !== turnoActual || (chusmasMovidasEsteTurno === 1 && img.dataset.pieceId !== "chusma")) { e.preventDefault(); return; }
        }
        draggingPieceId = img.dataset.pieceId; draggingArmy = img.dataset.army; draggingOriginTile = img.parentElement;
    };
    return img;
}

function finalizarTurnoCombate() {
    chusmasMovidasEsteTurno = 0; ultimaChusmaGid = null;
    turnoActual = (turnoActual === 'rojo') ? 'negro' : 'rojo';
    
    let msg = `Turno del ${turnoActual.toUpperCase()}`;
    if (isKingInCheck(turnoActual)) {
        msg = `¡JAQUE AL REY ${turnoActual.toUpperCase()}!`;
        // Aquí iría la validación de Jaque Mate simplificada
    }
    document.getElementById('status-msg').innerText = msg;
    updateInventories();
}

function handleRemove(e) {
    e.preventDefault(); if (faseJuego !== "despliegue") return;
    const img = e.currentTarget.querySelector('.piece-on-board');
    if (!img) return;
    const army = img.dataset.army, pid = img.dataset.pieceId, gid = img.dataset.groupId;
    if (pid === 'fortaleza') { fortalezaColocada[army] = false; if(army === bandoQueEmpezo) { bandoQueEmpezo = null; turnoActual = null; } }
    stock[army][pid]++;
    document.querySelectorAll(`[data-group-id="${gid}"]`).forEach(el => el.remove());
    updateInventories();
}

function actualizarZonas(r, c, army) {
    const coords = [], mit = mitadesAsignadas[army], minR = (mit === 'norte') ? 0 : 5, maxR = (mit === 'norte') ? 4 : 9;
    for (let i = r - 1; i <= r + 2; i++) for (let j = c - 1; j <= c + 2; j++) {
        if (!(i >= r && i <= r + 1 && j >= c && j <= c + 1) && i >= minR && i <= maxR && j >= 0 && j < 10) {
            coords.push(`${i},${j}`);
            const t = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
            if (t && !t.classList.contains('water')) t.classList.add('deploy-zone');
        }
    }
    zonasDespliegue[army] = coords;
}

window.onload = init;
</script>
</body>
</html>
